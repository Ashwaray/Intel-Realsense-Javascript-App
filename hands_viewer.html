<!DOCTYPE html>
<html>
<head>
    <title>Intel(R) RealSense(TM) SDK Web Sample</title>

    <script type="text/javascript" src="js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="js/promise-1.0.0.min.js"></script>
    <script type="text/javascript" src="js/realsense-3.0.js"></script>
    <script type="text/javascript" src="js/realsenseinfo-3.0.js"></script>
    <link rel="stylesheet" href="css/style.css" type="text/css" media="screen"/>
    <script type="text/javascript">
        $(document).ready(function () {
            var sense;
            var imageSize;
            var handModule;
            var handConfiguration;
            var menuOrder=1;//My Data
            var gestureStatusStr;///My Data
            var flag = 0;
            // check platform compatibility
            RealSenseInfo(['hand'], function (info) {
                if (info.IsReady == true) {
                    $('#info').append('<b>Platform supports Intel(R) RealSense(TM) SDK feature</b>');
                    status('OK');
                    document.getElementById("Start").disabled = false;
                } else {
                    status('Platform not supported: ' + info.responseText);
                    if (info.IsPlatformSupported != true) {
                        $('#info').append('<b>Intel® RealSense™ 3D camera not found</b>');
                    } else if (info.IsBrowserSupported != true) {
                        $('#info').append('<b>Please update your browser to latest version</b>');
                    } else {
                        $('#info').append('<b>Please download and install the following update(s) before running sample: </b>');
                        for (i = 0; i < info.Updates.length; i++) {
                            $('#info').append('<a href="' + info.Updates[i].url + '">' + info.Updates[i].href + '</a><br>');
                        }
                    }
                }
            })

            $('#Start').click(function () {
                document.getElementById("Start").disabled = true;
                PXCMSenseManager_CreateInstance().then(function (result) {
                    sense = result;
                    return sense.EnableHand(onHandData);
                }).then(function (result) {
                    handModule = result;
                    status('Init started');
                    return sense.Init(onConnect, onStatus);
                }).then(function (result) {
                    return handModule.CreateActiveConfiguration();
                }).then(function (result) {
                    handConfiguration = result;
                    if (document.getElementById("alerts").checked)
                        return handConfiguration.EnableAllAlerts();
                    else
                        return handConfiguration.DisableAllAlerts();
                }).then(function (result) {
                    if (document.getElementById("gestures").checked)
                        return handConfiguration.EnableAllGestures(false);
                    else
                        return handConfiguration.DisableAllGestures();
                }).then(function (result) {
                    return handConfiguration.ApplyChanges();
                }).then(function (result) {
                    return sense.QueryCaptureManager();
                }).then(function (capture) {
                    return capture.QueryImageSize(pxcmConst.PXCMCapture.STREAM_TYPE_DEPTH);
                }).then(function (result) {
                    imageSize = result.size;
                    return sense.StreamFrames();
                }).then(function (result) {
                    status('Streaming ' + imageSize.width + 'x' + imageSize.height);
                    document.getElementById("Stop").disabled = false;
                }).catch(function (error) {
                    status('Init failed: ' + JSON.stringify(error));
                    document.getElementById("Start").disabled = false;
                });
            });

            function clear() {
                $('#alerts_status').text('');
                $('#gestures_status').text('');
                document.getElementById("Start").disabled = false;
                var canvas = document.getElementById('myCanvas');
                var context = canvas.getContext('2d');
                context.clearRect(0, 0, canvas.width, canvas.height);
            }

            $('#Stop').click(function () {
                document.getElementById("Stop").disabled = true;
                sense.Close().then(function (result) {
                    status('Stopped');
                    clear();
                });
            });

            function sleep(milliseconds) {
              var start = new Date().getTime();
              for (var i = 0; i < 1e7; i++) {
                if ((new Date().getTime() - start) > milliseconds){
                  break;
                }
              }
            }

            function onHandData(mid, module, data) {
                var canvas = document.getElementById('myCanvas');
                var context = canvas.getContext('2d');
                var radius = 5;
                var scale = 1;
                flag = !flag;
                canvas.width = imageSize.width;
                canvas.height = imageSize.height;

                if (data.hands == 'undefined') return;
                for (h = 0; h < data.hands.length; h++) {
                    var joints = data.hands[h].trackedJoint;
                    var baseX = joints[0].positionImage.x;
                    var baseY = joints[0].positionImage.y;
                    var wristX = joints[0].positionImage.x;
                    var wristY = joints[0].positionImage.y;

                    for (j = 0; j < joints.length; j++) {
                        if (joints[j] == null || joints[j].confidence <= 0) continue;

                        var x = joints[j].positionImage.x;
                        var y = joints[j].positionImage.y;

                        context.beginPath();
                        context.arc(x * scale, y * scale, radius, 0, 2 * Math.PI);
                        context.lineWidth = 2;
                        context.strokeStyle = 'green';
                        context.stroke();

                        if (j == 2 || j == 6 || j == 10 || j == 14 || j == 18) {
                            baseX = wristX;
                            baseY = wristY;
                        }

                        context.beginPath();
                        context.moveTo(baseX * scale, baseY * scale);
                        context.lineTo(x * scale, y * scale);
                        context.stroke();

                        baseX = x;
                        baseY = y;
                    }
                }
                for (a = 0; a < data.alerts.length; a++) {
                    $('#alerts_status').text('Alert: ' + JSON.stringify(data.alerts[a]));
                }

                //loopDataGestures
                /*var loopCount=0;
                    setInterval(function(){
                    for (g = 0; g < data.gestures.length; g++) {
                    $('#gestures_status').text('Gesture: ' + JSON.stringify(data.gestures[g]));
                    $('#p1').append(JSON.stringify(data.gestures[g]));
                    gestureStatusStr = JSON.stringify(data.gestures[g].name);//My Data
                    activityMenu();
                        }
                    },20000);*/
            if (flag == 1) {
                for (g = 0; g < data.gestures.length; g++) {
                    $('#gestures_status').text('Gesture: ' + JSON.stringify(data.gestures[0]));
                    //$('#p1').append(JSON.stringify(data.gestures[g]));
                    gestureStatusStr = JSON.stringify(data.gestures[0].name);//My Data
                    var elem;
                    /*if (gestureStatusStr == '"spreadfingers"') {
                        //activityMenu();
                        expandMe(elem);
                        break;
                    } else */
                    if(gestureStatusStr=='"v_sign"' && menuOrder>=2){
                        elem = $('#home' + menuOrder.toString());
                        collapseMe(elem);
                        $('#p1').append("BefV"+" "+menuOrder+" ");
                        --menuOrder;
                        $('#p1').append("AftV"+" "+menuOrder+" ");
                        elem = $('#home' + menuOrder.toString());
                        expandMe(elem);
                        //activityMenu();
                        /*for (i=0; i<100000; i++) {
                            for (j=0; j<1000; j++) {

                            }
                        }*/
                        gestureStatusStr="";
                        //sense.PauseHand(true);
                        //sleep(500);
                        break;
                    } else if (gestureStatusStr=='"spreadfingers"' && menuOrder<5) {
                        elem = $('#home' + menuOrder.toString());
                        collapseMe(elem);
                        $('#p1').append("BefS"+" "+menuOrder +" ");
                        menuOrder++;
                        $('#p1').append("AftS"+" "+menuOrder+" ");
                        elem = $('#home' + menuOrder.toString());
                        expandMe(elem);
                        //sleep(500);
                        //activityMenu();
                        /*for (i=0; i<100000; i++) {
                            for (j=0; j<1000; j++) {

                            }
                        }*/
                        gestureStatusStr="";
                        //sense.PauseHand(true);
                        break;
                    }
                }
            }
                
                //alert(gestureStatusStr);
            }

            function onConnect(data) {
                if (data.connected == false) {
                    $('#alerts_status').append('Alert: ' + JSON.stringify(data) + '<br>');
                }
            }

            function onStatus(data) {
                if (data.sts < 0) {
                    status('Error ' + data.sts);
                    clear();
                }
            }

            function status(msg) {
                $('#status').text(msg);
            }

            function expandMe(elem){
                 var angle = 0;
                var t = setInterval(function () {
                    if(angle == 1440){
                        clearInterval(t);
                        return;
                    }
                    angle += 40;
                    $('.link',$elem).stop().animate({rotate: '+=-40deg'}, 0);
                },10);
                    elem.stop().animate({width:'268px'}, 300)
                    .find('.item_content').fadeIn(400,function(){
                    find('p').stop(true,true).fadeIn(600);
                });
            }

             function collapseMe(elem){
                var angle = 1440;
                var t = setInterval(function () {
                    if(angle == 0){
                        clearInterval(t);
                        return;
                    }
                    angle -= 40;
                    $('.link',$elem).stop().animate({rotate: '+=40deg'}, 0);
                },10);
                elem.stop().animate({width:'52px'}, 100)
                .find('.item_content').stop(true,true).fadeOut().find('p').stop(true,true).fadeOut();
            }

            /*function activityMenu(){
                var p1elem = $('#p1');
                //p1elem.text(gestureStatusStr);

                /*if(gestureStatusStr=='"v_sign"' && menuOrder>2){
                    menuOrder--;
                } else if (gestureStatusStr=='"thumb_down"' && menuOrder<5) {
                    menuOrder++;
                }

                var elem = $('#home' + menuOrder.toString());

                if(gestureStatusStr=='"spreadfingers"'){
                    expandMe(elem);
                } else {
                    collapseMe(elem);
                }
            }*/
        });
    </script>
</head>

<body>
    <div id="wrapper">
        <div id="container">

            <h1>Intel(R) RealSense(TM) SDK Hands Viewer Web Sample</h1>
            <p id="p1">Hello</p>
            <div id="info"></div>
            <br>
            <input id="gestures" type="checkbox"/>Gestures
            <input id="alerts" type="checkbox"/>Alerts
            <br>
            <br>
            <button id="Start">Start</button>
            <button id="Stop" disabled="disabled">Stop</button>
            <br>
            <br>

            <canvas id="myCanvas" style="border:1px solid #000000;display:none;"></canvas>

            <div id="gestures_status" style="display:block;"></div>
            <div id="alerts_status" style="display:block;"></div>
            <br>
            <span style="display:block;">Status:<div id="status"></div></span>
        

    <div style="float: left;padding: 0 0 0 236px;">
            <div class="item" id="home5">
                <a class="link icon_mail"></a>
                <div class="item_content">
                    <h2>Contact us</h2>
                    <p>
                        <a href="mailto:info@tympanus.net">eMail</a>
                        <a href="http://www.twitter.com/codrops/">Twitter</a>
                        <a href="http://www.facebook.com/pages/Codrops/159107397912">Facebook</a>
                    </p>
                </div>
            </div>
            <div class="item" id="home4">
                <a class="link icon_help"></a>
                <div class="item_content">
                    <h2>Help</h2>
                    <p>
                        <a href="#">FAQ</a>
                        <a href="#">Live Support</a>
                        <a href="#">Tickets</a>
                    </p>
                </div>
            </div>
            <div class="item" id="home3">
                <a class="link icon_find"></a>
                <div class="item_content">
                    <h2>Search</h2>
                    <p>
                        <input type="text"></input>
                        <a href="">Go</a>
                    </p>
                </div>
            </div>
            <div class="item" id="home2">
                <a class="link icon_photos"></a>
                <div class="item_content">
                    <h2>Image Gallery</h2>
                    <p>
                        <a href="#">Categories</a>
                        <a href="#">Archives</a>
                        <a href="#">Featured</a>
                    </p>
                </div>
            </div>
            <div class="item"  id="home1">
                <a class="link icon_home"></a>
                <div class="item_content">
                    <h2>Start from here</h2>
                    <p>
                        <a href="http://www.tympanus.net/">Services</a>
                        <a href="http://www.tympanus.net/">Portfolio</a>
                        <a href="http://www.tympanus.net/">Pricing</a>
                    </p>
                </div>
            </div>
        </div>
        </div>

    </div>
        <!-- <script type="text/javascript" src="js/jquery-1.11.0.min.js"></script>
        <script src="js/jquery-css-transform.js" type="text/javascript"></script> -->
        <script src="js/jquery-animate-css-rotate-scale.js" type="text/javascript"></script>
        <script>
            $('.item').hover(
                function(){
                    var $this = $(this);
                    expand($this);
                },
                function(){
                    var $this = $(this);
                    collapse($this);
                }
            );
            function expand($elem){
                var angle = 0;
                var t = setInterval(function () {
                    if(angle == 1440){
                        clearInterval(t);
                        return;
                    }
                    angle += 40;
                    $('.link',$elem).stop().animate({rotate: '+=-40deg'}, 0);
                },10);
                $elem.stop().animate({width:'268px'}, 1000)
                .find('.item_content').fadeIn(400,function(){
                    $(this).find('p').stop(true,true).fadeIn(600);
                });
            }
            function collapse($elem){
                var angle = 1440;
                var t = setInterval(function () {
                    if(angle == 0){
                        clearInterval(t);
                        return;
                    }
                    angle -= 40;
                    $('.link',$elem).stop().animate({rotate: '+=40deg'}, 0);
                },10);
                $elem.stop().animate({width:'52px'}, 1000)
                .find('.item_content').stop(true,true).fadeOut().find('p').stop(true,true).fadeOut();
            }
        </script>
</body>
</html>
