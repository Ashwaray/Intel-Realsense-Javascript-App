<!DOCTYPE html>
<html>
<head>
    <title>Intel(R) RealSense(TM) SDK</title>
    <link rel="stylesheet" href="css/bootstrap.css" type='text/css'>
    <link rel="stylesheet" href="css/custom.css" type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Bree+Serif|Merriweather:400,300,300italic,400italic,700,700italic' rel='stylesheet' type='text/css'>
    <script type="text/javascript" src="js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="js/promise-1.0.0.min.js"></script>
    <script type="text/javascript" src="js/realsense-3.0.js"></script>
    <script type="text/javascript" src="js/realsenseinfo-3.0.js"></script>
    <script type="text/javascript" src="js/bootstrap.min.js"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            var session;
            var speech_rec;
            var mode;
            var mode1;
            var sense;
            var imageSize;
            var faceConfiguration;

            // check platform compatibility
            RealSenseInfo(['nuance'], function (info) {
                if (info.IsReady == true) {
                    $('#info').append('<b>Platform supports Intel(R) RealSense(TM) SDK feature</b>');
                    status('OK');
                    document.getElementById("Start").disabled = false;
                } else {
                    $('#status').text('Platform not supported: ' + info.responseText);
                    if (info.IsPlatformSupported != true) {
                        $('#info').append('<b>Intel® RealSense™ 3D camera not found</b>');
                    } else if (info.IsBrowserSupported != true) {
                        $('#info').append('<b>Please update your browser to latest version</b>');
                    } else {
                        $('#info').append('<b>Please download and install the following update(s) before running sample: </b>');
                        for (i = 0; i < info.Updates.length; i++) {
                            $('#info').append('<a href="' + info.Updates[i].url + '">' + info.Updates[i].href + '</a><br>');
                        }
                    }
                }
            })

            $('#mode').change(function () {
                mode = $(this).val();
                if (mode == 0) {
                    document.getElementById("commands").style.display = "none";
                } else {
                    document.getElementById("commands").style.display = "block";
                }
            });

            $('#Start').click(function () {
                document.getElementById("Start").disabled = true;
                PXCMSession_CreateInstance().then(function (result) {
                    session = result;
                    status('Initilizing');
                    return session.CreateImpl(undefined, undefined, pxcmConst.PXCMSpeechRecognition.CUID);
                }).then(function (result) {
                    speech_rec = result;
                    var selects = document.getElementById("mode");
                    mode = Number(selects.options[selects.selectedIndex].value);
                    if (mode != 0) {
                        var commands = $('#commands').val().split('\n');
                        return speech_rec.BuildGrammarFromStringList(mode, commands, null);
                    } else {
                        return session.QueryVersion(); // for chain of operations
                    }
                }).then(function (result) {
                    if (mode != 0) {
                        return speech_rec.SetGrammar(mode);
                    } else {
                        return session.QueryVersion(); // for chain of operations
                    }
                }).then(function (result) {
                    status('Grammar created');
                    return speech_rec.StartRec(OnRecognition, OnAlert);
                }).then(function (result) {
                    status('Started');
                    document.getElementById("Stop").disabled = false;
                }).catch(function (error) {
                    status('StartRec failed: ' + JSON.stringify(error));
                    document.getElementById("Start").disabled = false;
                });

                /*PXCMSenseManager_CreateInstance().then(function (result1) {
                    sense = result1;
                    return sense.EnableFace(onFaceData);
                }).then(function (result1) {
                    return result1.CreateActiveConfiguration();
                }).then(function (result1) {
                    faceConfiguration = result1;
                    faceConfiguration.configs.detection.isEnabled = document.getElementById("detection").checked;
                    faceConfiguration.configs.landmarks.isEnabled = document.getElementById("landmarks").checked;
                    faceConfiguration.configs.pose.isEnabled = document.getElementById("pose").checked;
                    faceConfiguration.configs.expressionProperties.isEnabled = document.getElementById("expressions").checked;
                    var selects = document.getElementById("mode1");
                    var mode1 = Number(selects.options[selects.selectedIndex].value);
                    return faceConfiguration.SetTrackingMode(mode1);
                }).then(function (result1) {
                    return faceConfiguration.ApplyChanges();
                }).then(function (result1) {
                    status1('Init started');
                    return sense.Init(null, onStatus);
                }).then(function (result1) {
                    return sense.QueryCaptureManager();
                }).then(function (capture) {
                    return capture.QueryImageSize(pxcmConst.PXCMCapture.STREAM_TYPE_COLOR);
                }).then(function (result1) {
                    imageSize = result1.size;
                    return sense.StreamFrames();
                }).then(function (result1) {
                    status1('Streaming ' + imageSize.width + 'x' + imageSize.height);
                    document.getElementById("Stop").disabled = false;
                }).catch(function (error) {
                    status1('Init failed: ' + JSON.stringify(error));
                    document.getElementById("Start").disabled = false;
                });*/
            });

            function clear() {
                $('#pose_status').text('');
                $('#expressions_status').text('');
                document.getElementById("Start").disabled = false;
                var canvas = document.getElementById('myCanvas');
                var context = canvas.getContext('2d');
                context.clearRect(0, 0, canvas.width, canvas.height);
            }

            $('#Stop').click(function () {
                document.getElementById("Stop").disabled = true;
                speech_rec.StopRec().then(function (result) {
                    status('Stopped');
                    $('#alerts').text('');
                    $('#recognition').text('');
                    document.getElementById("Start").disabled = false;
                });
                sense.Close().then(function (result1) {
                    status('Stopped');
                    clear();
                });
            });

            function OnRecognition(result) {
                var res = result.data.scores[0];
                var r = res.sentence;
                var rec = r.split(' ');
                //alert(rec[1]);
                //$('#out').append("<b>RESULT</b>"+res.sentence);
                if (res.confidence !== 'undefined' && res.confidence >= 0) { 
                    if (res.sentence == "Left") {
                        $('#out').append("Word has been recognized "+res.sentence+' '+rec[1]+'<br>');
                        $('#start1').css("padding-left", "20px");
                        //alert(rec);
                    } else {
                        $('#out').append("Word not recognized "+'<br>');
                    }
                    //res.sentence += ' (' + res.confidence + '%)';
                }
                $('#recognition').append(res.sentence + '<br>');
                var obj = document.getElementById("recognition");
                obj.scrollTop = obj.scrollHeight;
            }

            function OnAlert(result) {
                $('#alerts').append(result.data.name + '<br>');
                var obj = document.getElementById("alerts");
                obj.scrollTop = obj.scrollHeight;
            }

            function status(msg) {
                $('#status').text(msg);
            }
            function status1(msg) {
                $('#status1').text(msg);
            }

        });
    </script>
</head>

<body>
    <div id="wrapper">
        <div class="container" style="padding-left:40px;">
            <div class="content row">
                <h1>RealSense Application using Voice Recognition</h1>

                <div id="info"></div>
                <br>
                <div id="info1"></div>
                <br>
                <br>
                Mode
                <select id="mode">
                    <option value=0>Dictation</option>
                    <option value=1>Command-control</option>
                </select>
                <br>
                <br>
                <select id="mode1">
                    <option value=0>2D</option>
                    <option value=1 selected="selected">3D</option>
                </select>
                <br>
                <textarea id="commands" cols="40" rows="5" style="display:none">left right</textarea>
                <br>
                Mode
                <input id="detection" type="checkbox" checked="checked" />Detection
                <input id="landmarks" type="checkbox" checked="checked" />Landmarks
                <input id="pose" type="checkbox" />Pose
                <input id="expressions" type="checkbox" />Expressions
                <br>
                <button id="Start">Start</button>
                <button id="Stop" disabled="disabled">Stop</button>
                <br>
                <div id="out"> </div>
                <br><b>Status:</b><div id="status"></div>
                <br><b>Status Face:</b><div id="status1"></div><br><br>
                <div id='start1'><img src="images/bg.jpg"> </div>
                <canvas id="myCanvas" style="border:1px solid #000000;"></canvas>
                <div id="pose_status"></div>
                <div id="expressions_status"></div>
                <br>
                <br><b>Recognition result:</b><div id="recognition" style="height: 150px; border:1px solid #000000; overflow: scroll; overflow-x: hidden"></div>
                <br><b>Alerts:</b><div id="alerts" style="height: 150px; border:1px solid #000000; overflow: scroll; overflow-x: hidden"></div>
            </div>
        </div>
    </div>
</body>
</html>
